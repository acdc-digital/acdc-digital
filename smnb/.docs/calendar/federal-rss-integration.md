# Federal RSS Feeds Integration Plan

## Overview
Integrate federal reports (SEC, Treasury, FOMC, etc.) into the calendar as time-based events alongside earnings reports.

## Architecture

### 1. Schema Extension
Extend `calendar_events` table to support event types:

```typescript
// Add to schema.ts
calendar_events: defineTable({
  title: v.string(),
  description: v.optional(v.string()),
  startTime: v.number(),
  endTime: v.number(),
  color: v.string(),
  allDay: v.boolean(),
  location: v.optional(v.string()),
  attendees: v.optional(v.array(v.string())),
  
  // NEW FIELDS for categorization
  eventType: v.union(
    v.literal("earnings"),
    v.literal("federal_report"),
    v.literal("user_event"),
    v.literal("economic_data")
  ),
  sourceUrl: v.optional(v.string()), // Link to original report
  metadata: v.optional(v.string()), // JSON blob for extra data
})
  .index("by_startTime", ["startTime"])
  .index("by_endTime", ["endTime"])
  .index("by_eventType", ["eventType", "startTime"]),
```

### 2. RSS Feed Sources

**Primary Federal Sources:**
- SEC Edgar RSS: https://www.sec.gov/cgi-bin/browse-edgar?action=getcurrent&output=atom
- Treasury Press Releases: https://home.treasury.gov/news/press-releases/rss
- Federal Reserve: https://www.federalreserve.gov/feeds/press_all.xml
- FOMC Minutes: https://www.federalreserve.gov/feeds/h15.xml

### 3. Implementation Components

#### A. Convex Action: RSS Fetcher
```typescript
// convex/federalReports.ts
"use node";
import { action } from "./_generated/server";
import { v } from "convex/values";
import { internal } from "./_generated/api";
import Parser from 'rss-parser';

export const fetchFederalReports = action({
  args: {
    source: v.union(
      v.literal("sec"),
      v.literal("treasury"),
      v.literal("fed"),
      v.literal("fomc")
    ),
  },
  handler: async (ctx, args) => {
    const parser = new Parser();
    const feedUrls = {
      sec: "https://www.sec.gov/cgi-bin/browse-edgar?action=getcurrent&output=atom",
      treasury: "https://home.treasury.gov/news/press-releases/rss",
      fed: "https://www.federalreserve.gov/feeds/press_all.xml",
      fomc: "https://www.federalreserve.gov/monetarypolicy/fomccalendars.htm",
    };

    const feed = await parser.parseURL(feedUrls[args.source]);
    
    const reports = feed.items.map(item => ({
      title: item.title || "Untitled Report",
      description: item.contentSnippet || item.content || "",
      publishDate: new Date(item.pubDate || item.isoDate || Date.now()).getTime(),
      sourceUrl: item.link || "",
      source: args.source,
    }));

    // Store in calendar
    for (const report of reports) {
      await ctx.runMutation(internal.calendar.createFederalReportEvent, {
        title: `[${args.source.toUpperCase()}] ${report.title}`,
        description: report.description,
        startTime: report.publishDate,
        endTime: report.publishDate + (24 * 60 * 60 * 1000), // 24 hours
        color: getFederalReportColor(args.source),
        allDay: true,
        sourceUrl: report.sourceUrl,
        eventType: "federal_report",
      });
    }

    return { success: true, count: reports.length };
  },
});

function getFederalReportColor(source: string): string {
  const colors = {
    sec: "#2563eb", // Blue
    treasury: "#059669", // Green
    fed: "#7c3aed", // Purple
    fomc: "#dc2626", // Red
  };
  return colors[source as keyof typeof colors] || "#6b7280";
}
```

#### B. Extended Calendar Mutations
```typescript
// convex/calendar.ts - Add to existing file

export const createFederalReportEvent = internalMutation({
  args: {
    title: v.string(),
    description: v.optional(v.string()),
    startTime: v.number(),
    endTime: v.number(),
    color: v.string(),
    allDay: v.boolean(),
    sourceUrl: v.optional(v.string()),
    eventType: v.literal("federal_report"),
  },
  handler: async (ctx, args) => {
    // Check if event already exists (prevent duplicates)
    const existing = await ctx.db
      .query("calendar_events")
      .filter((q) =>
        q.and(
          q.eq(q.field("title"), args.title),
          q.eq(q.field("startTime"), args.startTime)
        )
      )
      .first();

    if (existing) {
      console.log(`Federal report already exists: ${args.title}`);
      return existing._id;
    }

    const eventId = await ctx.db.insert("calendar_events", {
      title: args.title,
      description: args.description,
      startTime: args.startTime,
      endTime: args.endTime,
      color: args.color,
      allDay: args.allDay,
      location: undefined,
      attendees: undefined,
      eventType: args.eventType,
      sourceUrl: args.sourceUrl,
      metadata: JSON.stringify({ autoGenerated: true }),
    });

    return eventId;
  },
});
```

#### C. Frontend Integration (Calendar Component)
```tsx
// Calendar.tsx additions

// Add filter state
const [eventFilters, setEventFilters] = useState({
  earnings: true,
  federal_report: true,
  user_event: true,
  economic_data: true,
});

// Add sync button/schedule
const syncFederalReports = useMutation(api.federalReports.fetchFederalReports);

const handleSyncFederalReports = async () => {
  setIsSyncing(true);
  try {
    await Promise.all([
      syncFederalReports({ source: "sec" }),
      syncFederalReports({ source: "treasury" }),
      syncFederalReports({ source: "fed" }),
    ]);
    console.log("✅ Federal reports synced");
  } catch (error) {
    console.error("❌ Failed to sync federal reports:", error);
  } finally {
    setIsSyncing(false);
  }
};

// Filter events in render
const filteredEvents = monthEvents?.filter(event => 
  eventFilters[event.eventType as keyof typeof eventFilters]
);
```

#### D. UI Filter Controls
```tsx
// Add to calendar header
<div className="flex gap-2">
  <button
    onClick={() => setEventFilters(prev => ({ ...prev, earnings: !prev.earnings }))}
    className={`px-3 py-1 rounded text-xs ${eventFilters.earnings ? 'bg-green-600' : 'bg-gray-600'}`}
  >
    Earnings
  </button>
  <button
    onClick={() => setEventFilters(prev => ({ ...prev, federal_report: !prev.federal_report }))}
    className={`px-3 py-1 rounded text-xs ${eventFilters.federal_report ? 'bg-blue-600' : 'bg-gray-600'}`}
  >
    Federal Reports
  </button>
</div>
```

### 4. Scheduled Sync

**Option A: Convex Cron Job**
```typescript
// convex/crons.ts
import { cronJobs } from "convex/server";
import { internal } from "./_generated/api";

const crons = cronJobs();

crons.interval(
  "sync federal reports",
  { hours: 6 }, // Every 6 hours
  internal.federalReports.scheduledSync
);

export default crons;
```

**Option B: Client-side on mount** (like your earnings example)
- Simpler but less reliable
- Good for MVP/testing

### 5. Enhanced Event Display

```tsx
// EventDetailPanel.tsx
const EventCard = ({ event }: { event: CalendarEvent }) => {
  const isReport = event.eventType === "federal_report";
  
  return (
    <div className={`border-l-4 ${isReport ? 'border-blue-500' : 'border-green-500'}`}>
      <h3>{event.title}</h3>
      <p>{event.description}</p>
      {event.sourceUrl && (
        <a href={event.sourceUrl} target="_blank" className="text-blue-500">
          View Report →
        </a>
      )}
      <span className="text-xs text-gray-500">
        {event.eventType === "federal_report" ? "Federal Report" : "Earnings"}
      </span>
    </div>
  );
};
```

## Implementation Steps

### Phase 1: Schema & Backend (30 min)
1. Update schema with eventType, sourceUrl, metadata
2. Run Convex migration
3. Create federalReports.ts action
4. Test RSS fetching manually

### Phase 2: Frontend Integration (45 min)
1. Update Calendar.tsx with filters
2. Add sync button
3. Update event styling based on type
4. Test display

### Phase 3: Automation (15 min)
1. Set up cron job OR
2. Add useEffect sync on component mount

### Phase 4: Polish (30 min)
1. Add loading states
2. Error handling
3. Toast notifications
4. Event detail enhancements

## Dependencies

```bash
pnpm add rss-parser
pnpm add -D @types/rss-parser
```

## Security Considerations

- RSS feeds are public, no API keys needed
- Rate limiting: Cache results, sync every 6-12 hours
- CORS: Use Convex action (server-side) to avoid CORS issues
- Validation: Sanitize RSS feed data before storage

## Future Enhancements

1. **AI Summaries**: Use Claude to summarize long reports
2. **Search**: Full-text search across report descriptions
3. **Notifications**: Alert on specific keywords (e.g., "interest rate", "regulation")
4. **Trends**: Track frequency of report types over time
5. **Related Events**: Link reports to affected tickers
